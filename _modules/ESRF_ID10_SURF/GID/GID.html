<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESRF_ID10_SURF.GID.GID &#8212; esrf_id10_surf  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ESRF_ID10_SURF.GID.GID</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">patches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lmfit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lmfit.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaussianModel</span><span class="p">,</span> <span class="n">LorentzianModel</span><span class="p">,</span> <span class="n">VoigtModel</span><span class="p">,</span> <span class="n">PseudoVoigtModel</span><span class="p">,</span> <span class="n">LinearModel</span><span class="p">,</span> <span class="n">ConstantModel</span>

<span class="c1"># --- Main GID Class ---</span>

<div class="viewcode-block" id="GID">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GID</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main class for processing GID (Grazing Incidence Diffraction) data.</span>

<span class="sd">    This class handles loading data from HDF5 files, processing it (normalization,</span>
<span class="sd">    conversion to reciprocal space), and visualizing/saving the results.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        file (str): Path to the HDF5 data file.</span>
<span class="sd">        scans (np.ndarray): Array of scan numbers to be processed.</span>
<span class="sd">        alpha_i_name (str): Name of the incident angle motor/counter.</span>
<span class="sd">        detector_name (str): Name of the detector dataset.</span>
<span class="sd">        monitor_name (str): Name of the monitor counter.</span>
<span class="sd">        transmission_name (str): Name of the transmission counter.</span>
<span class="sd">        att_name (str): Name of the attenuator counter.</span>
<span class="sd">        cnttime_name (str): Name of the counting time counter.</span>
<span class="sd">        angle_name (str): Name of the angle motor (e.g., &#39;delta&#39;).</span>
<span class="sd">        energy_name (str): Name of the energy motor.</span>
<span class="sd">        PX0 (float): Pixel index of the direct beam (or reference pixel).</span>
<span class="sd">        mythen_gap (int): Gap size in pixels between detector modules.</span>
<span class="sd">        PPD (float): Pixels per degree calibration factor.</span>
<span class="sd">        I0 (float): Incident intensity normalization factor.</span>
<span class="sd">        saving_dir (str): Directory where output files will be saved.</span>
<span class="sd">        data (np.ndarray): Raw detector data.</span>
<span class="sd">        angle (np.ndarray): Array of angles corresponding to the data.</span>
<span class="sd">        alpha_i (np.ndarray): Incident angle values.</span>
<span class="sd">        monitor (np.ndarray): Monitor counts.</span>
<span class="sd">        transmission (np.ndarray): Transmission values.</span>
<span class="sd">        attenuator (np.ndarray): Attenuator values.</span>
<span class="sd">        cnttime (np.ndarray): Counting times.</span>
<span class="sd">        energy (float): Beam energy in keV.</span>
<span class="sd">        sample_name (str): Name of the sample extracted from metadata.</span>
<span class="sd">        Pi (int or str): Surface pressure (Pi) value if available.</span>
<span class="sd">        data_gap (np.ndarray): Processed 2D data map with gap handling.</span>
<span class="sd">        qz (np.ndarray): Array of qz values.</span>
<span class="sd">        qxy (np.ndarray): Array of qxy values.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">alpha_i_name</span><span class="o">=</span><span class="s1">&#39;chi&#39;</span><span class="p">,</span> <span class="n">detector_name</span><span class="o">=</span><span class="s1">&#39;mythen2&#39;</span><span class="p">,</span> <span class="n">monitor_name</span><span class="o">=</span><span class="s1">&#39;mon&#39;</span><span class="p">,</span>
                 <span class="n">transmission_name</span><span class="o">=</span><span class="s1">&#39;autof_eh1_transm&#39;</span><span class="p">,</span> <span class="n">att_name</span><span class="o">=</span><span class="s1">&#39;autof_eh1_curratt&#39;</span><span class="p">,</span> <span class="n">cnttime_name</span><span class="o">=</span><span class="s1">&#39;sec&#39;</span><span class="p">,</span>
                 <span class="n">PX0</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">mythen_gap</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">PPD</span><span class="o">=</span><span class="mf">198.5</span><span class="p">,</span> <span class="n">pixel_size_qxz</span><span class="o">=</span><span class="mf">0.055</span><span class="p">,</span> <span class="n">angle_name</span><span class="o">=</span><span class="s1">&#39;delta&#39;</span><span class="p">,</span> <span class="n">energy_name</span><span class="o">=</span><span class="s1">&#39;monoe&#39;</span><span class="p">,</span>
                 <span class="n">I0</span><span class="o">=</span><span class="mf">1e12</span><span class="p">,</span> <span class="n">saving_dir</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the GID processor.</span>

<span class="sd">        Args:</span>
<span class="sd">            file (str): Path to the HDF5 file.</span>
<span class="sd">            scans (list or int): List of scan numbers or a single scan number.</span>
<span class="sd">            alpha_i_name (str, optional): Name of incident angle dataset. Defaults to &#39;chi&#39;.</span>
<span class="sd">            detector_name (str, optional): Name of detector dataset. Defaults to &#39;mythen2&#39;.</span>
<span class="sd">            monitor_name (str, optional): Name of monitor dataset. Defaults to &#39;mon&#39;.</span>
<span class="sd">            transmission_name (str, optional): Name of transmission dataset. Defaults to &#39;autof_eh1_transm&#39;.</span>
<span class="sd">            att_name (str, optional): Name of attenuator dataset. Defaults to &#39;autof_eh1_curratt&#39;.</span>
<span class="sd">            cnttime_name (str, optional): Name of count time dataset. Defaults to &#39;sec&#39;.</span>
<span class="sd">            PX0 (float, optional): Direct beam pixel position. Defaults to 50.</span>
<span class="sd">            mythen_gap (int, optional): Number of pixels in the detector gap. Defaults to 120.</span>
<span class="sd">            PPD (float, optional): Pixels per degree. Defaults to 198.5.</span>
<span class="sd">            pixel_size_qxz (float, optional): Pixel size in reciprocal space (unused in init). Defaults to 0.055.</span>
<span class="sd">            angle_name (str, optional): Name of the angle motor. Defaults to &#39;delta&#39;.</span>
<span class="sd">            energy_name (str, optional): Name of the energy motor. Defaults to &#39;monoe&#39;.</span>
<span class="sd">            I0 (float, optional): Normalization intensity. Defaults to 1e12.</span>
<span class="sd">            saving_dir (str, optional): Directory to save outputs. Defaults to None (creates based on sample name).</span>
<span class="sd">            *args: Variable length argument list.</span>
<span class="sd">            **kwargs: Arbitrary keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_i_name</span> <span class="o">=</span> <span class="n">alpha_i_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_name</span> <span class="o">=</span> <span class="n">detector_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor_name</span> <span class="o">=</span> <span class="n">monitor_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission_name</span> <span class="o">=</span> <span class="n">transmission_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">att_name</span> <span class="o">=</span> <span class="n">att_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_name</span> <span class="o">=</span> <span class="n">energy_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnttime_name</span> <span class="o">=</span> <span class="n">cnttime_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_name</span> <span class="o">=</span> <span class="n">angle_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">PX0</span> <span class="o">=</span> <span class="n">PX0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mythen_gap</span> <span class="o">=</span> <span class="n">mythen_gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PPD</span> <span class="o">=</span> <span class="n">PPD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I0</span> <span class="o">=</span> <span class="n">I0</span>

        <span class="c1"># Initialize attributes to store data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>  <span class="c1"># Placeholder for the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attenuator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cnttime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">saving_dir</span>



        <span class="c1"># Processed data containers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap_e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qxy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__load_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__process_2D_data__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_saving_dir</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__load_single_scan__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ScanN</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data for a single scan from the HDF5 file.</span>

<span class="sd">        Args:</span>
<span class="sd">            ScanN (str): The scan numbers are a list of scans.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: If there is an error reading the file or dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading scan #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ScanN</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># Using [()] to read dataset into numpy array immediately</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">alpha_i</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/instrument/positioners/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_i_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transmission_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attenuator</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cnttime</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cnttime_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>

                <span class="n">energy</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/instrument/positioners/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[()]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

                <span class="n">sample_name_ds</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/sample/name/&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sample_name_ds</span><span class="p">:</span>
                    <span class="c1"># Handle string decoding if necessary</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sample_name_ds</span><span class="p">[()])[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">pi_ds</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/fb_Pi&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pi_ds</span><span class="p">:</span>
                    <span class="n">Pi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pi_ds</span><span class="p">[()])</span>
                    <span class="k">if</span> <span class="n">Pi</span> <span class="o">&lt;</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading scan </span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loaded scan #</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ScanN</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__load_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_points</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load data from all specified scans.</span>

<span class="sd">        If multiple scans are provided, they are concatenated.</span>

<span class="sd">        Args:</span>
<span class="sd">            skip_points (int, optional): Number of initial points to skip in each scan</span>
<span class="sd">                (often used to skip the start of a scan where motors are accelerating). Defaults to 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start loading data.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ScanN</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_single_scan__</span><span class="p">(</span><span class="n">ScanN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load first scan to initialize arrays</span>
            <span class="n">first_ScanN</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__load_single_scan__</span><span class="p">(</span><span class="n">first_ScanN</span><span class="p">)</span>

            <span class="c1"># Append subsequent scans</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">each</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">ScanN</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">each</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loading scan </span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">skip_points</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="n">data_x</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span>
                            <span class="p">()]</span>  <span class="c1"># Assuming angle matches data points, adjusting skip_points if needed</span>
                        <span class="c1"># Note: original code didn&#39;t slice data_x with skip_points, but did for others.</span>
                        <span class="c1"># Assuming data_x (angle) aligns with detector data.</span>
                        <span class="c1"># If data_x has same length as data, it should be sliced too?</span>
                        <span class="c1"># Original code: self.angle = np.append(self.angle, data_x) (no slicing)</span>
                        <span class="c1"># But typically measurement arrays are same length.</span>
                        <span class="c1"># I will keep original behavior but it looks suspicious if skip_points &gt; 0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">,</span> <span class="n">data_x</span><span class="p">)</span>

                        <span class="n">data_mon</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">skip_points</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">,</span> <span class="n">data_mon</span><span class="p">)</span>

                        <span class="n">data_transm</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transmission_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">skip_points</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transmission</span><span class="p">,</span> <span class="n">data_transm</span><span class="p">)</span>

                        <span class="n">data_att</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">att_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">skip_points</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">attenuator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attenuator</span><span class="p">,</span> <span class="n">data_att</span><span class="p">)</span>

                        <span class="n">cnttime</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">.1/measurement/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cnttime_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">skip_points</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cnttime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cnttime</span><span class="p">,</span> <span class="n">cnttime</span><span class="p">)</span>

                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Loaded scan #</span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error appending scan </span><span class="si">{</span><span class="n">ScanN</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading completed. Reading time </span><span class="si">%3.3f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<div class="viewcode-block" id="GID.get_qz">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.get_qz">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_qz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the vertical scattering vector qz.</span>

<span class="sd">        Args:</span>
<span class="sd">            pixels (np.ndarray): Array of pixel indices (vertical position on detector).</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Array of qz values in inverse Angstroms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate qz. Assuming alpha_i is scalar or matches dimensions if it varies.</span>
        <span class="c1"># Here we treat alpha_i as a scalar (first value) if it&#39;s an array to produce a 1D qz array for pixels.</span>
        <span class="n">alpha_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_i</span>

        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">12.398</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>   <span class="c1"># in Angstroms</span>
        <span class="n">k0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span>

        <span class="c1"># pixels are an array</span>
        <span class="n">qz</span> <span class="o">=</span> <span class="n">k0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">alpha_i</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">((</span><span class="n">pixels</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">PX0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">PPD</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">qz</span></div>


<div class="viewcode-block" id="GID.get_qxy">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.get_qxy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_qxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the horizontal scattering vector qxy.</span>

<span class="sd">        Args:</span>
<span class="sd">            angle (float or np.ndarray): In-plane scattering angle in degrees.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or np.ndarray: qxy value(s) in inverse Angstroms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavelength</span> <span class="o">=</span> <span class="mf">12.398</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
        <span class="n">k0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span>
        <span class="n">qxy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angle</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">qxy</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__process_2D_data__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the raw 2D detector data.</span>

<span class="sd">        This involves:</span>
<span class="sd">        1. Handling the physical gap in the detector modules.</span>
<span class="sd">        2. Normalizing data by monitor and transmission.</span>
<span class="sd">        3. Calculating qz and qxy axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start processing 2D data.&quot;</span><span class="p">)</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Handle gaps in detector modules (Mythen is built from 2 modules)</span>
        <span class="n">map2Dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mythen_gap</span><span class="p">))</span>

        <span class="c1"># Specific slicing for Mythen detector (1280 pixels per module)</span>
        <span class="c1"># Original code had hardcoded indices: 0:1279 and 1280:2559</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="o">&gt;=</span> <span class="mi">2559</span><span class="p">:</span>
            <span class="n">map2Dm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1279</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1279</span><span class="p">]</span>
            <span class="n">map2Dm</span><span class="p">[:,</span> <span class="p">(</span><span class="mi">1280</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mythen_gap</span><span class="p">):(</span><span class="mi">2559</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mythen_gap</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="mi">1280</span><span class="p">:</span><span class="mi">2559</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback if dimensions don&#39;t match expectation</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Data shape </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> does not match expected Mythen format. Using raw data.&quot;</span><span class="p">)</span>
            <span class="n">map2Dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="n">nxm</span><span class="p">,</span> <span class="n">nym</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">map2Dm</span><span class="p">)</span>

        <span class="c1"># Normalize by monitor and transmission</span>
        <span class="c1"># Ensure monitor and transmission are properly broadcasted</span>
        <span class="c1"># self.monitor is 1D (nx,), map2Dm is 2D (nx, nym)</span>

        <span class="n">norm_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transmission</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Avoid division by zero</span>
        <span class="n">norm_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">norm_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">norm_factor</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span> <span class="o">=</span> <span class="n">map2Dm</span> <span class="o">/</span> <span class="n">norm_factor</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">I0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_gap_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">map2Dm</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm_factor</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">I0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">qz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nym</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qxy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing completed. Processing time </span><span class="si">%3.3f</span><span class="s2"> sec </span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<div class="viewcode-block" id="GID.plot_2D_image">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.plot_2D_image">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_2D_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the 2D GID map in reciprocal space (qxy vs qz).</span>

<span class="sd">        Args:</span>
<span class="sd">            ax (matplotlib.axes.Axes, optional): Axes to plot on. If None, a new figure is created.</span>
<span class="sd">            save (bool, optional): Whether to save the figure to disk. Defaults to False.</span>
<span class="sd">            **kwargs: Additional arguments passed to `imshow`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            matplotlib.axes.Axes: The axes containing the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax0</span> <span class="o">=</span> <span class="n">ax</span>

        <span class="c1"># Determine colormap limits for better contrast</span>
        <span class="n">mean_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">)</span>
        <span class="n">std_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">)</span>
        <span class="n">_vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">mean_val</span> <span class="o">-</span> <span class="n">std_val</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">))</span>  <span class="c1"># Avoid log of negative/zero</span>
        <span class="n">_vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mean_val</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std_val</span><span class="p">)</span>

        <span class="c1"># extent=[xmin, xmax, ymin, ymax]</span>
        <span class="c1"># data_gap is (angles, pixels). Rot90 rotates it.</span>
        <span class="c1"># qxy corresponds to angles (rows originally), qz corresponds to pixels (cols originally).</span>
        <span class="c1"># np.rot90(m, k=1) rotates 90 degrees counter-clockwise.</span>
        <span class="c1"># Original: rows=angles(x), cols=pixels(z).</span>
        <span class="c1"># Rotated: rows=pixels(z), cols=angles(x) (reversed).</span>


        <span class="n">im</span> <span class="o">=</span> <span class="n">ax0</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">)),</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">_vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">_vmax</span><span class="p">,</span>
                        <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">)),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$q_</span><span class="si">{xy}</span><span class="s1">, </span><span class="se">\\</span><span class="s1">AA^{-1}$&#39;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$q_</span><span class="si">{z}</span><span class="s1">, </span><span class="se">\\</span><span class="s1">AA^{-1}$&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving 2D GID map.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_figure</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">(),</span> <span class="s1">&#39;2Dmap&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ax0</span></div>


<div class="viewcode-block" id="GID.get_qxy_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.get_qxy_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_qxy_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a 1D cut along qxy by integrating over a range of qz.</span>

<span class="sd">        Args:</span>
<span class="sd">            qz_min (float): Minimum qz value.</span>
<span class="sd">            qz_max (float): Maximum qz value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list containing [qxy, intensity_profile].</span>
<span class="sd">                  intensity_profile is sum of counts in the qz range.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find indices for qz range</span>
        <span class="n">qz_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span> <span class="o">&gt;</span> <span class="n">qz_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span> <span class="o">&lt;</span> <span class="n">qz_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qz_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No data in qz range [</span><span class="si">{</span><span class="n">qz_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">qz_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">)]</span>

        <span class="n">cut_qxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[:,</span> <span class="n">qz_indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">,</span> <span class="n">cut_qxy</span><span class="p">]</span></div>


<div class="viewcode-block" id="GID.save_qxy_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.save_qxy_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_qxy_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the qxy cut data to a text file.</span>

<span class="sd">        Args:</span>
<span class="sd">            qz_min (float): Minimum qz value.</span>
<span class="sd">            qz_max (float): Maximum qz value.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qxy</span><span class="p">,</span> <span class="n">cut_qxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qxy_cut</span><span class="p">(</span><span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qxy</span><span class="p">,</span> <span class="n">cut_qxy</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_sample_dir</span><span class="p">()</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span> <span class="s1">&#39;/GID_</span><span class="si">{}</span><span class="s1">_scan_</span><span class="si">{}</span><span class="s1">_qxy_cut_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_A.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">,</span> <span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GID cut saved as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic plotting function for 1D cuts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Filename must be provided if save is True.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving plot to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="GID.plot_qxy_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.plot_qxy_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qxy_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the qxy cut.</span>

<span class="sd">        Args:</span>
<span class="sd">            qz_min (float): Minimum qz value.</span>
<span class="sd">            qz_max (float): Maximum qz value.</span>
<span class="sd">            ax (matplotlib.axes.Axes, optional): Axes to plot on.</span>
<span class="sd">            save (bool, optional): Whether to save the figure. Defaults to False.</span>
<span class="sd">            **kwargs: Additional arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qxy</span><span class="p">,</span> <span class="n">cut_qxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qxy_cut</span><span class="p">(</span><span class="n">qz_min</span><span class="p">,</span> <span class="n">qz_max</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$Cut</span><span class="se">\\</span><span class="s1">: </span><span class="si">{</span><span class="n">qz_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&lt;q_z&lt;</span><span class="si">{</span><span class="n">qz_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">$&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/qxy_cut_</span><span class="si">{</span><span class="n">qz_min</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">qz_max</span><span class="si">}</span><span class="s1">_A.png&#39;</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_cut</span><span class="p">(</span><span class="n">qxy</span><span class="p">,</span> <span class="n">cut_qxy</span><span class="p">,</span> <span class="s1">&#39;$q_</span><span class="si">{xy}</span><span class="s1">, </span><span class="se">\\</span><span class="s1">AA^{-1}$&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="GID.get_qz_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.get_qz_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_qz_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a 1D cut along qz by integrating over a range of qxy.</span>

<span class="sd">        Args:</span>
<span class="sd">            qxy_min (float): Minimum qxy value.</span>
<span class="sd">            qxy_max (float): Maximum qxy value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list containing [qz, intensity_profile].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qxy_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span> <span class="o">&gt;</span> <span class="n">qxy_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span> <span class="o">&lt;</span> <span class="n">qxy_max</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qxy_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: No data in qxy range [</span><span class="si">{</span><span class="n">qxy_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">qxy_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">)]</span>

        <span class="n">cut_qz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">[</span><span class="n">qxy_indices</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">,</span> <span class="n">cut_qz</span><span class="p">]</span></div>


<div class="viewcode-block" id="GID.save_qz_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.save_qz_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_qz_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the qz cut data to a text file.</span>

<span class="sd">        Args:</span>
<span class="sd">            qxy_min (float): Minimum qxy value.</span>
<span class="sd">            qxy_max (float): Maximum qxy value.</span>
<span class="sd">            **kwargs: Additional keyword arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qz</span><span class="p">,</span> <span class="n">cut_qz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qz_cut</span><span class="p">(</span><span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">qz</span><span class="p">,</span> <span class="n">cut_qz</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_sample_dir</span><span class="p">()</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span> <span class="s1">&#39;/GID_</span><span class="si">{}</span><span class="s1">_scan_</span><span class="si">{}</span><span class="s1">_qz_cut_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_A.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">,</span> <span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GID cut saved as: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span></div>


<div class="viewcode-block" id="GID.plot_qz_cut">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.plot_qz_cut">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_qz_cut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the qz cut.</span>

<span class="sd">        Args:</span>
<span class="sd">            qxy_min (float): Minimum qxy value.</span>
<span class="sd">            qxy_max (float): Maximum qxy value.</span>
<span class="sd">            ax (matplotlib.axes.Axes, optional): Axes to plot on.</span>
<span class="sd">            save (bool, optional): Whether to save the figure. Defaults to False.</span>
<span class="sd">            **kwargs: Additional arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qz</span><span class="p">,</span> <span class="n">cut_qz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_qz_cut</span><span class="p">(</span><span class="n">qxy_min</span><span class="p">,</span> <span class="n">qxy_max</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$Cut</span><span class="se">\\</span><span class="s1">: </span><span class="si">{</span><span class="n">qxy_min</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&lt;q_</span><span class="se">{{</span><span class="s1">xy</span><span class="se">}}</span><span class="s1">&lt;</span><span class="si">{</span><span class="n">qxy_max</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">$&#39;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/qz_cut_</span><span class="si">{</span><span class="n">qxy_min</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">qxy_max</span><span class="si">}</span><span class="s1">_A.png&#39;</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_cut</span><span class="p">(</span><span class="n">qz</span><span class="p">,</span> <span class="n">cut_qz</span><span class="p">,</span> <span class="s1">&#39;$q_</span><span class="si">{z}</span><span class="s1">, </span><span class="se">\\</span><span class="s1">AA^{-1}$&#39;</span><span class="p">,</span> <span class="s1">&#39;Intensity&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">save</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="GID.plot_quick_analysis">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.plot_quick_analysis">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_quick_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a quick standard analysis plot including the 2D map and representative qxy cuts.</span>

<span class="sd">        Args:</span>
<span class="sd">            save (bool, optional): Whether to save the figure. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_2D_image</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Default limits, might need adjustment based on data</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">))</span>

        <span class="c1"># Example lines, these should probably be configurable</span>
        <span class="c1"># ax[0].hlines([0.01, 0.3], 1.2, 1.6, linestyle=&#39;--&#39;, alpha=0.8, color=&#39;C0&#39;)</span>
        <span class="c1"># ax[0].hlines([0.5, 0.95], 1.2, 1.6, linestyle=&#39;--&#39;, alpha=0.8, color=&#39;C1&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_qxy_cut</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_qxy_cut</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;GID : Sample </span><span class="si">{}</span><span class="s1">, Scan </span><span class="si">{}</span><span class="s1">, Pi = </span><span class="si">{}</span><span class="s1"> mN/m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving standard GID plot.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_figure</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="s1">&#39;quick_analysis&#39;</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_saving_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the saving directory is set; if not, set a default based on the current working directory and sample name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">&quot;</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_sample_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure the saving directory exists, creating it if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving directory is impossible: &#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to save a matplotlib figure.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig (matplotlib.figure.Figure): The figure object to save.</span>
<span class="sd">            suffix (str): Suffix to append to the filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_sample_dir</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span> <span class="s1">&#39;/GID_</span><span class="si">{}</span><span class="s1">_scan_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="c1"># --- New Features ---</span>

<div class="viewcode-block" id="GID.fit_profile">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.fit_profile">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a profile to the specified model with background using lmfit.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): The independent variable array (e.g., q).</span>
<span class="sd">            y (np.ndarray): The dependent variable array (e.g., Intensity).</span>
<span class="sd">            model (str, optional): The peak model to use. Options are &#39;gaussian&#39;,</span>
<span class="sd">                &#39;lorentzian&#39;, &#39;voigt&#39;, &#39;pseudo_voigt&#39;. Defaults to &#39;gaussian&#39;.</span>
<span class="sd">            background (str, optional): The background model. Options are &#39;linear&#39;,</span>
<span class="sd">                &#39;constant&#39;, or None. Defaults to &#39;linear&#39;.</span>
<span class="sd">            limits (tuple, optional): A tuple (min, max) to restrict the fitting range.</span>
<span class="sd">                Defaults to None (use full range).</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to `mod.fit`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            lmfit.model.ModelResult: The result of the fit.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an unknown model is specified.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Apply limits</span>
        <span class="k">if</span> <span class="n">limits</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">y_fit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">y_fit</span> <span class="o">=</span> <span class="n">y</span>

        <span class="c1"># Select model</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;peak_&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;lorentzian&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">LorentzianModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;peak_&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;voigt&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">VoigtModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;peak_&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;pseudo_voigt&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">PseudoVoigtModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;peak_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Select background</span>
        <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;bg_&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">ConstantModel</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;bg_&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">bg</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">peak</span> <span class="o">+</span> <span class="n">bg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">peak</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>

        <span class="c1"># Initial guesses</span>
        <span class="k">if</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_fit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_fit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">intercept</span> <span class="o">=</span> <span class="n">y_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_fit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bg_slope&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">slope</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bg_intercept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">intercept</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">background</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bg_c&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y_fit</span><span class="p">))</span>

        <span class="c1"># Peak guess</span>
        <span class="c1"># We use lmfit&#39;s guess but try to be smart about background</span>
        <span class="c1"># If we have background, subtracting it before guessing might be better,</span>
        <span class="c1"># but simpler is to let lmfit guess on raw data and hope it works or overwrite bg params.</span>
        <span class="c1"># Actually peak.guess(y, x=x) often does a good job finding the peak even with background,</span>
        <span class="c1"># but it resets all params in the model if called on the composite model?</span>
        <span class="c1"># No, peak.guess returns a Parameters object.</span>

        <span class="c1"># Strategy: guess peak params using peak.guess, update params.</span>
        <span class="n">peak_params</span> <span class="o">=</span> <span class="n">peak</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">y_fit</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x_fit</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">peak_params</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y_fit</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x_fit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="GID.analyze_peak">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.analyze_peak">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;voigt&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename_prefix</span><span class="o">=</span><span class="s1">&#39;fit_result&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for fit_profile to perform analysis, plotting, and saving.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): The independent variable array.</span>
<span class="sd">            y (np.ndarray): The dependent variable array.</span>
<span class="sd">            model (str, optional): Fitting model. Defaults to &#39;voigt&#39;.</span>
<span class="sd">            background (str, optional): Background model. Defaults to &#39;linear&#39;.</span>
<span class="sd">            limits (tuple, optional): Fitting limits (min, max). Defaults to None.</span>
<span class="sd">            save (bool, optional): Whether to save plots and reports. Defaults to False.</span>
<span class="sd">            filename_prefix (str, optional): Prefix for saved files. Defaults to &#39;fit_result&#39;.</span>
<span class="sd">            **kwargs: Extra arguments for fit_profile or lmfit.</span>

<span class="sd">        Returns:</span>
<span class="sd">            lmfit.model.ModelResult: The result object from `fit_profile`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> profile...&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_profile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1">#print(result.fit_report())</span>

        <span class="c1"># Plot</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">limits</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            <span class="n">fit_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Fit&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fit_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> Peak Fit&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_sample_dir</span><span class="p">()</span>
            <span class="n">fname_base</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">fig_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname_base</span><span class="si">}</span><span class="s2">.png&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_name</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Graph saved to </span><span class="si">{</span><span class="n">fig_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">txt_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fname_base</span><span class="si">}</span><span class="s2">.txt&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txt_name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> __________________________</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fit_line</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit parameters saved to </span><span class="si">{</span><span class="n">txt_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="GID.save_image_h5">
<a class="viewcode-back" href="../../../GID.html#ESRF_ID10_SURF.GID.GID.save_image_h5">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_image_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the 2D image data to an HDF5 file in q-coordinates.</span>

<span class="sd">        This saves the intensity map, qxy axis, and qz axis, along with metadata.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str, optional): The name of the file to save. If None, it is auto-generated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_sample_dir</span><span class="p">()</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">+</span><span class="s1">&#39;/GID_</span><span class="si">{}</span><span class="s1">_scan_</span><span class="si">{}</span><span class="s1">_2D.h5&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hf</span><span class="p">:</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_gap</span><span class="p">)</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;qxy&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qxy</span><span class="p">)</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;qz&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">qz</span><span class="p">)</span>

                <span class="c1"># Add metadata</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;sample_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_name</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;pi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pi</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span>
                <span class="n">hf</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;2D image saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error saving H5 file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">esrf_id10_surf</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../GID.html">GID Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../XRR.html">XRR Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ESRF_ID10_SURF.GISAXS.html">ESRF_ID10_SURF.GISAXS package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html">Initializing the library, necessary imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#Definition-of-the-path-to-files-and-scan-numbers">Definition of the path to files and scan numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#X-ray-reflectivity">X-ray reflectivity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#Grazing-Incidence-Diffraction">Grazing Incidence Diffraction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html">Initializing the library, necessary imports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#Definition-of-the-path-to-files-and-scan-numbers">Definition of the path to files and scan numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#X-ray-reflectivity">X-ray reflectivity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage_example.html#Grazing-Incidence-Diffraction">Grazing Incidence Diffraction</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, Egor A. Bersenev.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>